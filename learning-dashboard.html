<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학습 현황 - AduSafe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- 네비게이션 -->
    <nav class="navbar navbar-custom">
        <div class="container-main">
            <div class="d-flex justify-content-between align-items-center w-100">
                <a class="navbar-brand" href="index.html">AdSafe</a>
                <div class="d-flex align-items-center gap-3">
                    <a href="index.html" class="nav-link text-decoration-none">대시보드</a>
                    <a href="adusafe-menu.html" class="nav-link text-decoration-none">학습하기</a>
                    <a href="inspection-history.html" class="nav-link text-decoration-none">검수 이력</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 메인 컨텐츠 -->
    <div class="container-main py-5">
        <div class="mb-4">
            <h1 class="mb-2">학습 현황</h1>
            <p class="text-muted">나의 학습 이력과 정답률을 확인하세요.</p>
        </div>

        <!-- 통계 요약 (localStorage adusafe_history 기반) -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card-custom text-center">
                    <h3 class="mb-2 text-primary" id="stat-quizzes">0</h3>
                    <p class="text-muted mb-0">총 퀴즈 횟수</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom text-center">
                    <h3 class="mb-2 text-info" id="stat-total">0</h3>
                    <p class="text-muted mb-0">총 풀은 문제 수</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom text-center">
                    <h3 class="mb-2 text-success" id="stat-correct">0</h3>
                    <p class="text-muted mb-0">총 정답 수</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card-custom text-center">
                    <h3 class="mb-2 text-warning" id="stat-rate">0%</h3>
                    <p class="text-muted mb-0">평균 정답률</p>
                </div>
            </div>
        </div>

        <!-- 최근 학습 이력 (실제 저장된 데이터) -->
        <div class="card-custom">
            <h5 class="card-title">최근 학습 이력</h5>
            <div id="history-empty" class="text-muted py-4 text-center" style="display: none;">
                아직 학습 이력이 없습니다. <a href="adusafe-menu.html">학습하기</a>에서 퀴즈를 풀어보세요.
            </div>
            <div id="history-table-wrap" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-custom mb-0">
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th>정답 / 문제 수</th>
                                <th>정답률</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody"></tbody>
                    </table>
                </div>
            </div>
            <div class="mt-3">
                <a href="adusafe-menu.html" class="btn btn-outline-custom btn-sm">학습하기</a>
                <a href="adusafe-review.html" class="btn btn-outline-custom btn-sm ms-2">복습하기</a>
            </div>
        </div>
    </div>

    <div class="footer-notice">
        <div class="container-main">
            본 서비스는 참고용이며 법적 판정이 아닙니다. 최종 책임은 사용자에게 있습니다.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script>if(!window.AdSafeAuth.getCurrentUser()){window.location.href='login.html';}</script>
    <script src="main.js"></script>
    <script>
        (function() {
            var apiBase = (window.ADSAFE_API_URL || '').replace(/\/$/, '');
            var emptyEl = document.getElementById('history-empty');
            var tableWrap = document.getElementById('history-table-wrap');
            var tbody = document.getElementById('history-tbody');

            var ngrokHeaders = { 'ngrok-skip-browser-warning': 'true' };
            
            // API에서 학습 현황 가져오기
            fetch(apiBase + '/api/learning-progress?user_id=1&workspace_id=1', { headers: ngrokHeaders })
                .then(function(res) {
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    return res.json();
                })
                .then(function(data) {
                    var totalQuizzes = data.totalAttempts || 0;
                    var totalQuestions = data.totalQuestions || 0;
                    var totalCorrect = data.totalCorrect || 0;
                    var avgRate = data.accuracy || 0;
                    var history = data.history || [];

                    document.getElementById('stat-quizzes').textContent = totalQuizzes;
                    document.getElementById('stat-total').textContent = totalQuestions;
                    document.getElementById('stat-correct').textContent = totalCorrect;
                    document.getElementById('stat-rate').textContent = avgRate + '%';

                    if (history.length === 0) {
                        emptyEl.style.display = 'block';
                        tableWrap.style.display = 'none';
                    } else {
                        emptyEl.style.display = 'none';
                        tableWrap.style.display = 'block';
                        history.forEach(function(h) {
                            var dateStr = '-';
                            if (h.date) {
                                try {
                                    var d = new Date(h.date);
                                    dateStr = d.getFullYear() + '.' + String(d.getMonth() + 1).padStart(2, '0') + '.' + String(d.getDate()).padStart(2, '0') + ' ' + String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
                                } catch (e) {}
                            }
                            var total = h.totalQuestions || 0;
                            var correct = h.correctCount || 0;
                            var rate = h.accuracy != null ? h.accuracy : 0;
                            var tr = document.createElement('tr');
                            tr.innerHTML = '<td>' + dateStr + '</td><td>' + correct + ' / ' + total + '</td><td>' + rate + '%</td>';
                            tbody.appendChild(tr);
                        });
                    }
                })
                .catch(function(err) {
                    console.error(err);
                    emptyEl.style.display = 'block';
                    tableWrap.style.display = 'none';
                    emptyEl.innerHTML = '학습 현황을 불러올 수 없습니다. API 서버를 확인해 주세요.';
                });
        })();
    </script>
</body>
</html>
