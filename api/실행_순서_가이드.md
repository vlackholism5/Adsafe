# AdSafe API 실행 순서 가이드 (PHP + XAMPP)

이제 AdSafe의 API는 **Node가 아니라 PHP**로 동작합니다.  
즉, **XAMPP Apache(80 포트)** 만 켜져 있으면 `/AdSafe/api/*`가 바로 동작합니다.

---

## 0번: XAMPP 확인

XAMPP Control Panel에서 **Apache**가 실행 중인지 확인합니다.

---

## 1번: DB 접속 정보(.env) 확인

PHP API는 `c:\\xampp\\htdocs\\AdSafe\\api\\.env` 파일의 DB 설정을 그대로 사용합니다.

---

## 2번: API 헬스 체크

브라우저에서 아래가 열리면 정상입니다.

- `http://localhost/AdSafe/api/health`

---

## 2-1. (선택) DB 연결 진단 — 시드가 계속 실패할 때

**뭘 하는 거냐면:** 비밀번호가 읽히는지, SSL은 되는지, MySQL 연결이 어디서 막히는지 단계별로 확인하는 스크립트입니다.

1. (선택) Node 도구로 DB 연결을 진단하려면, api 폴더에서:
   ```text
   cd c:\xampp\htdocs\AdSafe\api
   npm run check-db
   ```
2. 화면에 **1. .env 파일**, **2. dotenv 로드 후**, **3. SSL 인증서**, **4. MySQL 연결 시도** 순서로 나옵니다.
3. **DB_PASSWORD**가 "(비어있음)" 또는 "(없음)"이면 → .env 저장·경로·이름 확인.
4. **4번**에서 "연결 실패" 메시지가 나오면 → 그 문구를 보고 원인(비밀번호/SSL/방화벽 등)을 짚을 수 있습니다.

---

## 3번: 시드 실행 (DB에 기본 데이터 넣기)

**뭘 하는 거냐면:** 검수 결과를 DB에 저장하려면, “기본 조직 1개, 관리자 1명, 리스크 분류(risk_taxonomy)”가 DB에 있어야 합니다. 이걸 한 번에 넣는 단계입니다.

**어떻게 하면 되나요:**

1. **터미널이 api 폴더에 있는지 확인한다.**
   - 없으면 다시:
     ```text
     cd c:\xampp\htdocs\AdSafe\api
     ```

2. **아래 명령을 입력하고 엔터한다.**
   ```text
   npm run seed
   ```

3. **화면에** “시드 완료.” 같은 메시지가 나오면 성공이다.  
   에러가 나오면: `.env`의 비밀번호·호스트·DB이름, 그리고 `ca.pem` 위치가 맞는지 확인한다.

4. **최초 1회만** 하면 되고, 다음부터는 4번만 하면 된다.

---

## 4번: (선택) 시드 실행

검수 결과를 DB에 저장하려면 **workspace 1건, 사용자 1건, risk_taxonomy**가 필요합니다.  
현재 시드는 Node 스크립트로 제공되며(런타임은 PHP), **최초 1회만** 실행하면 됩니다.

```text
cd c:\xampp\htdocs\AdSafe\api
npm run seed
```

---

## 검수 이력에 기록이 안 남을 때

**증상:** 검수하기를 실행하면 결과는 보이는데, **검수 이력** 페이지에는 아무 것도 안 나옵니다.

**가능한 원인과 확인 방법:**

1. **시드 미실행**  
   검수 결과를 DB에 넣으려면 **workspace 1개, 사용자 1명, risk_taxonomy**가 있어야 합니다.  
   → **3번**을 다시 실행: `npm run seed`

2. **DB 저장 가능 여부 진단**  
   api 폴더에서 아래를 실행해 보세요.
   ```text
   node scripts/test-inspect-save.js
   ```
   - **"DB 저장 가능 상태입니다"** 가 나오면 → DB는 정상. 브라우저에서 검수 후 **F12 → Network** 탭에서 `inspect` 요청의 **응답(Response)** 에 `saveError`가 있는지 확인하세요.
   - **"원인: workspace_id=1 이 없습니다"** 등이 나오면 → `npm run seed` 를 먼저 실행하세요.

3. **API 서버와 페이지 주소**  
   - 검수 페이지는 **http://localhost/AdSafe/adsafe.html** (XAMPP 80 포트), API는 **http://localhost/api/** (같은 80 포트, Apache가 Node로 프록시) 로 호출됩니다.  
   - Apache 프록시 설정(`apache-api-proxy.conf` Include)과 Node 서버(`npm start`)가 둘 다 켜져 있어야 합니다.

---

## 정리: 순서만 보기 (PHP 기준)

| 순서 | 뭘 하면 되는지 |
| --- | --- |
| **0** | XAMPP에서 Apache 켜기 |
| **1** | `api/.env`에 DB 정보 확인(비밀번호/CA 포함) |
| **2** | `http://localhost/AdSafe/api/health` 열어보기 |
| **4** | (선택) 최초 1회 `npm run seed` 로 기본 데이터 넣기 |

이제는 **Node/프록시 없이** Apache(PHP)만으로 검수/이력이 동작합니다.