<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>룰셋 버전 - 어드민 콘솔</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <!-- 네비게이션 -->
    <nav class="navbar navbar-custom">
        <div class="container-main">
            <div class="d-flex justify-content-between align-items-center w-100">
                <a class="navbar-brand" href="../index.html">AdSafe</a>
                <div class="d-flex align-items-center gap-3">
                    <a href="../index.html" class="nav-link text-decoration-none">대시보드</a>
                    <span class="text-muted">|</span>
                    <span class="text-primary fw-bold">어드민 콘솔</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 사이드바 -->
            <div class="col-md-3 col-lg-2 sidebar-admin">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="bi bi-people me-2"></i>사용자 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="taxonomy.html">
                            <i class="bi bi-diagram-3 me-2"></i>리스크 택소노미
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="ruleset.html">
                            <i class="bi bi-collection me-2"></i>룰셋 버전
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="rules.html">
                            <i class="bi bi-list-check me-2"></i>룰 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="audit.html">
                            <i class="bi bi-journal-text me-2"></i>감사 로그
                        </a>
                    </li>
                </ul>
            </div>

            <!-- 메인 컨텐츠 -->
            <div class="col-md-9 col-lg-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="mb-2">룰셋 버전</h1>
                        <p class="text-muted">룰셋 버전을 관리하고 활성화합니다.</p>
                    </div>
                    <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addRulesetModal">
                        <i class="bi bi-plus-circle me-2"></i>새 버전 생성
                    </button>
                </div>

                <div class="card-custom p-0">
                    <div class="table-responsive">
                        <table class="table table-custom mb-0">
                            <thead>
                                <tr>
                                    <th>버전명</th>
                                    <th>업종</th>
                                    <th>상태</th>
                                    <th>룰 수</th>
                                    <th>생성일</th>
                                    <th>활성화일</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="ruleset-tbody">
                                <!-- js/rule-set-versions.js + ADU_RULES 기반 동적 렌더링 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 룰셋 추가 모달 -->
    <div class="modal fade" id="addRulesetModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">새 룰셋 버전 생성</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="ruleset-name" class="form-label">버전명</label>
                            <input type="text" class="form-control form-control-custom" id="ruleset-name" placeholder="v2.2.0" required>
                        </div>
                        <div class="mb-3">
                            <label for="ruleset-industry" class="form-label">업종</label>
                            <select class="form-select form-control-custom" id="ruleset-industry">
                                <option value="general">일반</option>
                                <option value="medical">의료</option>
                                <option value="health_supplement">건강기능식품</option>
                                <option value="other">기타</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="ruleset-changelog" class="form-label">변경내역</label>
                            <textarea class="form-control form-control-custom" id="ruleset-changelog" rows="4" placeholder="변경 사항을 입력하세요..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-custom" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary-custom">생성</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 룰셋 상세 모달 -->
    <div class="modal fade" id="detailRulesetModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">룰셋 버전 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-3">버전명</dt>
                        <dd class="col-sm-9" id="detail-versionName">-</dd>
                        <dt class="col-sm-3">업종</dt>
                        <dd class="col-sm-9" id="detail-industry">-</dd>
                        <dt class="col-sm-3">상태</dt>
                        <dd class="col-sm-9" id="detail-status">-</dd>
                        <dt class="col-sm-3">룰 수</dt>
                        <dd class="col-sm-9" id="detail-ruleCount">-</dd>
                        <dt class="col-sm-3">생성일</dt>
                        <dd class="col-sm-9" id="detail-createdAt">-</dd>
                        <dt class="col-sm-3">활성화일</dt>
                        <dd class="col-sm-9" id="detail-activatedAt">-</dd>
                    </dl>
                    <div id="detail-ruleListWrap" class="mt-3 d-none">
                        <hr>
                        <h6 class="mb-2">포함 룰 (리스크 코드)</h6>
                        <ul id="detail-ruleList" class="small text-muted mb-0 list-unstyled"></ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-custom" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-notice">
        <div class="container-main">
            본 서비스는 참고용이며 법적 판정이 아닙니다. 최종 책임은 사용자에게 있습니다.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/rules-data.js"></script>
    <script src="../js/rule-set-versions.js"></script>
    <script src="../js/audit-logs.js"></script>
    <script src="../main.js"></script>
    <script>
(function() {
    var STORAGE_KEY = 'adsafe_ruleset_versions';
    var statusBadge = {
        active: { label: '활성', class: 'bg-success' },
        inactive: { label: '비활성', class: 'bg-secondary' },
        deprecated: { label: '폐기', class: 'bg-danger' },
        draft: { label: '초안', class: 'bg-warning' }
    };

    function getVersions() {
        try {
            var raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
                var parsed = JSON.parse(raw);
                if (Array.isArray(parsed) && parsed.length) return parsed;
            }
        } catch (e) {}
        if (typeof window.ADU_RULE_SET_VERSIONS !== 'undefined') {
            return JSON.parse(JSON.stringify(window.ADU_RULE_SET_VERSIONS));
        }
        return [];
    }

    function saveVersions(list) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        } catch (e) {}
    }

    function getRuleCount(item) {
        if (item.ruleCount != null) return item.ruleCount;
        return (window.ADU_RULES && Array.isArray(window.ADU_RULES)) ? window.ADU_RULES.length : 0;
    }

    function getIndustryLabel(key) {
        return (window.ADU_RULE_SET_INDUSTRY_LABELS && window.ADU_RULE_SET_INDUSTRY_LABELS[key]) || key || '-';
    }

    function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function todayStr() {
        var d = new Date();
        return d.getFullYear() + '.' + String(d.getMonth() + 1).padStart(2, '0') + '.' + String(d.getDate()).padStart(2, '0');
    }

    function renderTable() {
        var tbody = document.getElementById('ruleset-tbody');
        var list = getVersions();
        if (!tbody) return;
        tbody.innerHTML = '';
        list.forEach(function(item) {
            var st = statusBadge[item.status] || { label: item.status, class: 'bg-secondary' };
            var ruleCount = getRuleCount(item);
            var industryLabel = getIndustryLabel(item.industryKey);
            var activatedAt = item.activatedAt ? escapeHtml(item.activatedAt) : '-';
            var actions = '<button type="button" class="btn btn-sm btn-outline-custom me-1 btn-detail" data-id="' + escapeHtml(item.id) + '">상세</button>';
            if (item.status === 'active') {
                actions += '<button type="button" class="btn btn-sm btn-outline-custom btn-deactivate" data-id="' + escapeHtml(item.id) + '">비활성화</button>';
            } else if (item.status === 'inactive' || item.status === 'draft') {
                actions += '<button type="button" class="btn btn-sm btn-primary-custom btn-activate" data-id="' + escapeHtml(item.id) + '">활성화</button>';
            }
            var tr = document.createElement('tr');
            tr.innerHTML =
                '<td><strong>' + escapeHtml(item.versionName) + '</strong></td>' +
                '<td>' + escapeHtml(industryLabel) + '</td>' +
                '<td><span class="badge ' + st.class + '">' + escapeHtml(st.label) + '</span></td>' +
                '<td>' + ruleCount + '개</td>' +
                '<td>' + escapeHtml(item.createdAt) + '</td>' +
                '<td>' + activatedAt + '</td>' +
                '<td>' + actions + '</td>';
            tbody.appendChild(tr);
        });

        tbody.querySelectorAll('.btn-detail').forEach(function(btn) {
            btn.addEventListener('click', openDetail);
        });
        tbody.querySelectorAll('.btn-deactivate').forEach(function(btn) {
            btn.addEventListener('click', doDeactivate);
        });
        tbody.querySelectorAll('.btn-activate').forEach(function(btn) {
            btn.addEventListener('click', doActivate);
        });
    }

    function openDetail(e) {
        var id = e.currentTarget.getAttribute('data-id');
        var list = getVersions();
        var item = list.find(function(v) { return v.id === id; });
        if (!item) return;
        var st = statusBadge[item.status] || { label: item.status };
        document.getElementById('detail-versionName').textContent = item.versionName;
        document.getElementById('detail-industry').textContent = getIndustryLabel(item.industryKey);
        document.getElementById('detail-status').innerHTML = '<span class="badge ' + (statusBadge[item.status] ? statusBadge[item.status].class : 'bg-secondary') + '">' + st.label + '</span>';
        document.getElementById('detail-ruleCount').textContent = getRuleCount(item) + '개';
        document.getElementById('detail-createdAt').textContent = item.createdAt || '-';
        document.getElementById('detail-activatedAt').textContent = item.activatedAt || '-';
        var wrap = document.getElementById('detail-ruleListWrap');
        var ul = document.getElementById('detail-ruleList');
        if (item.status === 'active' && window.ADU_RULES && Array.isArray(window.ADU_RULES)) {
            ul.innerHTML = '';
            window.ADU_RULES.forEach(function(r) {
                var li = document.createElement('li');
                li.textContent = r.riskCode + ' — ' + (r.level1 || '') + ' / ' + (r.level2 || '') + ' / ' + (r.level3 || '');
                ul.appendChild(li);
            });
            wrap.classList.remove('d-none');
        } else {
            wrap.classList.add('d-none');
        }
        var modal = new bootstrap.Modal(document.getElementById('detailRulesetModal'));
        modal.show();
    }

    function doDeactivate(e) {
        var id = e.currentTarget.getAttribute('data-id');
        var list = getVersions();
        var item = list.find(function(v) { return v.id === id; });
        if (!item || item.status !== 'active') return;
        var versionName = item.versionName;
        item.status = 'inactive';
        item.activatedAt = null;
        saveVersions(list);
        if (typeof window.pushAuditLog === 'function') {
            window.pushAuditLog({ action: 'RULESET_DEACTIVATED', entityType: 'rule_set_versions', entityId: id, summary: versionName + ' 비활성화' });
        }
        renderTable();
    }

    function doActivate(e) {
        var id = e.currentTarget.getAttribute('data-id');
        var list = getVersions();
        var item = list.find(function(v) { return v.id === id; });
        if (!item || (item.status !== 'inactive' && item.status !== 'draft')) return;
        list.forEach(function(v) {
            if (v.status === 'active') {
                v.status = 'inactive';
                v.activatedAt = null;
            }
        });
        item.status = 'active';
        item.activatedAt = todayStr();
        saveVersions(list);
        if (typeof window.pushAuditLog === 'function') {
            window.pushAuditLog({ action: 'RULESET_ACTIVATED', entityType: 'rule_set_versions', entityId: item.id, summary: item.versionName + ' 활성화' });
        }
        renderTable();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', renderTable);
    } else {
        renderTable();
    }
})();
    </script>
</body>
</html>
