<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>감사 로그 - 어드민 콘솔</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <!-- 네비게이션 -->
    <nav class="navbar navbar-custom">
        <div class="container-main">
            <div class="d-flex justify-content-between align-items-center w-100">
                <a class="navbar-brand" href="../index.html">AdSafe</a>
                <div class="d-flex align-items-center gap-3">
                    <a href="../index.html" class="nav-link text-decoration-none">대시보드</a>
                    <span class="text-muted">|</span>
                    <span class="text-primary fw-bold">어드민 콘솔</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 사이드바 -->
            <div class="col-md-3 col-lg-2 sidebar-admin">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="bi bi-people me-2"></i>사용자 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="taxonomy.html">
                            <i class="bi bi-diagram-3 me-2"></i>리스크 택소노미
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ruleset.html">
                            <i class="bi bi-collection me-2"></i>룰셋 버전
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="rules.html">
                            <i class="bi bi-list-check me-2"></i>룰 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="audit.html">
                            <i class="bi bi-journal-text me-2"></i>감사 로그
                        </a>
                    </li>
                </ul>
            </div>

            <!-- 메인 컨텐츠 -->
            <div class="col-md-9 col-lg-10 p-4">
                <div class="mb-4">
                    <h1 class="mb-2">감사 로그</h1>
                    <p class="text-muted">시스템 주요 이벤트 및 변경 이력을 조회합니다.</p>
                </div>

                <!-- 필터 -->
                <div class="card-custom mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">액션</label>
                            <select class="form-select form-control-custom" id="audit-filter-action">
                                <option value="">전체</option>
                                <option value="RULESET_ACTIVATED">RULESET_ACTIVATED</option>
                                <option value="RULESET_DEACTIVATED">RULESET_DEACTIVATED</option>
                                <option value="RULE_UPDATED">RULE_UPDATED</option>
                                <option value="RULE_CREATED">RULE_CREATED</option>
                                <option value="TAXONOMY_UPDATED">TAXONOMY_UPDATED</option>
                                <option value="TAXONOMY_LOADED">TAXONOMY_LOADED</option>
                                <option value="USER_DISABLED">USER_DISABLED</option>
                                <option value="USER_INVITED">USER_INVITED</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">엔티티 타입</label>
                            <select class="form-select form-control-custom" id="audit-filter-entity">
                                <option value="">전체</option>
                                <option value="rule_set_versions">rule_set_versions</option>
                                <option value="rules">rules</option>
                                <option value="risk_taxonomy">risk_taxonomy</option>
                                <option value="users">users</option>
                                <option value="invitations">invitations</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">기간</label>
                            <select class="form-select form-control-custom" id="audit-filter-period">
                                <option value="7">최근 7일</option>
                                <option value="30">최근 30일</option>
                                <option value="90">최근 3개월</option>
                                <option value="all">전체</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-custom w-100" id="audit-filter-btn">검색</button>
                        </div>
                    </div>
                </div>

                <!-- 로그 테이블 -->
                <div class="card-custom p-0">
                    <div class="table-responsive">
                        <table class="table table-custom mb-0">
                            <thead>
                                <tr>
                                    <th>일시</th>
                                    <th>수행자</th>
                                    <th>액션</th>
                                    <th>엔티티 타입</th>
                                    <th>엔티티 ID</th>
                                    <th>변경 요약</th>
                                </tr>
                            </thead>
                            <tbody id="audit-tbody">
                                <!-- js/audit-logs.js + localStorage 기반 동적 렌더링 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 페이지네이션 -->
                <nav aria-label="페이지 네비게이션" class="mt-4" id="audit-pagination"></nav>
            </div>
        </div>
    </div>

    <div class="footer-notice">
        <div class="container-main">
            본 서비스는 참고용이며 법적 판정이 아닙니다. 최종 책임은 사용자에게 있습니다.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/audit-logs.js"></script>
    <script src="../main.js"></script>
    <script>
(function() {
    var PER_PAGE = 10;
    var actionBadge = {
        RULESET_ACTIVATED: 'bg-success',
        RULESET_DEACTIVATED: 'bg-secondary',
        RULE_UPDATED: 'bg-info',
        RULE_CREATED: 'bg-primary',
        TAXONOMY_UPDATED: 'bg-info',
        TAXONOMY_LOADED: 'bg-secondary',
        USER_DISABLED: 'bg-warning',
        USER_INVITED: 'bg-success'
    };

    function getLogs() {
        var list = typeof window.getAuditLogs === 'function' ? window.getAuditLogs() : [];
        if (list.length === 0 && window.ADU_AUDIT_LOGS_SEED && Array.isArray(window.ADU_AUDIT_LOGS_SEED)) {
            list = JSON.parse(JSON.stringify(window.ADU_AUDIT_LOGS_SEED));
            if (typeof window.saveAuditLogs === 'function') window.saveAuditLogs(list);
        }
        return list;
    }

    function parseTimestamp(ts) {
        if (!ts) return 0;
        var m = String(ts).match(/^(\d{4})\.(\d{1,2})\.(\d{1,2})\s+(\d{1,2}):(\d{1,2})/);
        if (m) return new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10), parseInt(m[4],10), parseInt(m[5],10)).getTime();
        return 0;
    }

    function getFilteredLogs() {
        var list = getLogs();
        var action = document.getElementById('audit-filter-action') && document.getElementById('audit-filter-action').value;
        var entity = document.getElementById('audit-filter-entity') && document.getElementById('audit-filter-entity').value;
        var period = document.getElementById('audit-filter-period') && document.getElementById('audit-filter-period').value;
        if (action) list = list.filter(function(l) { return l.action === action; });
        if (entity) list = list.filter(function(l) { return l.entityType === entity; });
        if (period && period !== 'all') {
            var days = parseInt(period, 10);
            var cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
            list = list.filter(function(l) { return parseTimestamp(l.timestamp) >= cutoff; });
        }
        return list;
    }

    function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function renderTable(page) {
        page = page || 1;
        var list = getFilteredLogs();
        var total = list.length;
        var start = (page - 1) * PER_PAGE;
        var slice = list.slice(start, start + PER_PAGE);
        var tbody = document.getElementById('audit-tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        slice.forEach(function(log) {
            var badgeClass = actionBadge[log.action] || 'bg-secondary';
            var tr = document.createElement('tr');
            tr.innerHTML =
                '<td>' + escapeHtml(log.timestamp) + '</td>' +
                '<td>' + escapeHtml(log.actor) + '</td>' +
                '<td><span class="badge ' + badgeClass + '">' + escapeHtml(log.action) + '</span></td>' +
                '<td>' + escapeHtml(log.entityType) + '</td>' +
                '<td>' + escapeHtml(log.entityId) + '</td>' +
                '<td><small>' + escapeHtml(log.summary) + '</small></td>';
            tbody.appendChild(tr);
        });
        renderPagination(total, page);
    }

    function renderPagination(total, currentPage) {
        var totalPages = Math.max(1, Math.ceil(total / PER_PAGE));
        var nav = document.getElementById('audit-pagination');
        if (!nav) return;
        if (totalPages <= 1) {
            nav.innerHTML = '';
            return;
        }
        var ul = document.createElement('ul');
        ul.className = 'pagination justify-content-center mb-0';
        var prev = document.createElement('li');
        prev.className = 'page-item' + (currentPage <= 1 ? ' disabled' : '');
        prev.innerHTML = '<a class="page-link" href="#" data-page="' + (currentPage - 1) + '">이전</a>';
        ul.appendChild(prev);
        for (var i = 1; i <= totalPages; i++) {
            var li = document.createElement('li');
            li.className = 'page-item' + (i === currentPage ? ' active' : '');
            li.innerHTML = '<a class="page-link" href="#" data-page="' + i + '">' + i + '</a>';
            ul.appendChild(li);
        }
        var next = document.createElement('li');
        next.className = 'page-item' + (currentPage >= totalPages ? ' disabled' : '');
        next.innerHTML = '<a class="page-link" href="#" data-page="' + (currentPage + 1) + '">다음</a>';
        ul.appendChild(next);
        nav.innerHTML = '';
        nav.appendChild(ul);
        nav.querySelectorAll('.page-link').forEach(function(a) {
            a.addEventListener('click', function(e) {
                e.preventDefault();
                var p = parseInt(a.getAttribute('data-page'), 10);
                if (isNaN(p) || p < 1) p = 1;
                if (p > totalPages) p = totalPages;
                renderTable(p);
            });
        });
    }

    function init() {
        renderTable(1);
        var btn = document.getElementById('audit-filter-btn');
        if (btn) btn.addEventListener('click', function() { renderTable(1); });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
    </script>
</body>
</html>
