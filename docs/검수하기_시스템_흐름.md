# 검수하기 버튼 클릭 시 시스템 흐름

사용자가 **검수하기** 버튼을 눌렀을 때 브라우저 → API → PHP → DB → JSON이 어떻게 연결되는지 정리한 문서입니다.

---

## 1. 전체 흐름 요약 (한눈에 보기)

```
[브라우저] adsafe.html
    → main.js: 검수하기 클릭
    → POST /AdSafe/api/inspect (JSON body)
         ↓
[Apache] .htaccess → api/index.php
    → routes.php: path=/inspect, method=POST → handle_inspect()
         ↓
[PHP] api/handlers/inspect.php
    → read_json_body() → adsafe_inspect_run($rawText)
         ↓
[PHP] api/engine/inspection_engine.php
    → adsafe_normalize() (normalize.php)
    → adsafe_rules() (rules_data.php → DB 또는 rules_data.json)
    → 키워드/정규식 매칭 → findings 생성
         ↓
[PHP] handlers/inspect.php (다시)
    → get_pdo() → MySQL INSERT
        - inspection_runs 1건
        - inspection_findings N건
         ↓
[PHP] json_response($result)
         ↓
[브라우저] main.js
    → res.json() → renderInspectionResultWithData(data)
    → 화면에 결과·하이라이트·상세 리스크 표시
```

---

## 2. 브라우저 (클라이언트)

### 2.1 화면

- **파일**: `adsafe.html`
- **버튼**: `<button id="btn-inspect">` → "검수하기"

### 2.2 이벤트 및 API 호출

- **파일**: `main.js`
- **동작**:
  1. `#btn-inspect` 클릭 시 `#ad-text`(광고 문구), 프로젝트, 제목, 로그인 사용자 ID 수집
  2. `POST` 요청 URL: `window.ADSAFE_API_URL + '/api/inspect'`  
     (기본: `/AdSafe/api/inspect`, 동일 호스트 80 포트)
  3. **요청 body (JSON)**:
     ```json
     {
       "text": "사용자가 입력한 광고 문구",
       "project": "프로젝트명(선택)",
       "title": "광고 제목(선택)",
       "user_id": 1
     }
     ```
  4. 응답을 `res.json()`으로 파싱 후 `renderInspectionResultWithData(data, rawText)` 호출
  5. `data.runId`가 있으면 "검수 결과가 DB에 저장되었습니다" 문구 표시  
     `data.saveError`가 있으면 DB 저장 실패 안내

### 2.3 응답 JSON 구조 (API가 돌려주는 것)

```json
{
  "summary": {
    "level": "none|low|medium|high",
    "totalFindings": 0,
    "message": "리스크 신호가 감지되지 않았습니다."
  },
  "findings": [
    {
      "riskCode": "RISK_XXX",
      "riskLevel": "medium",
      "matchedText": "매칭된 문구",
      "explanation": "설명",
      "suggestion": "수정 가이드",
      "level1": "가격",
      "level2": "과도 할인",
      "level3": "50% 이상"
    }
  ],
  "rawText": "원문",
  "normalizedText": "정규화된 문구",
  "processingMs": 12,
  "runId": 123,
  "saveError": null
}
```

- `runId`: DB에 저장된 검수 실행 ID (저장 실패 시 없거나 null)
- `saveError`: DB 저장 중 오류 시 에러 메시지

---

## 3. 서버 진입 (Apache → PHP)

### 3.1 URL 라우팅

- **요청**: `POST http://localhost/AdSafe/api/inspect`
- **api/.htaccess**:
  - `RewriteRule ^(.*)$ index.php [QSA,L]`  
  - `/api/*` 요청이 실제 파일이 아니면 `api/index.php`로 전달

### 3.2 PHP 진입점

- **api/index.php**
  - `require lib/bootstrap.php` → CORS, `json_response()`, `read_json_body()`, `get_pdo()` 등 공통 설정
  - `require routes.php` → 경로/메서드에 따른 라우팅

### 3.3 라우팅

- **api/routes.php**
  - `$path` = `/inspect` (마운트 prefix 제거 후)
  - `$method` = `POST`
  - 조건: `$path === '/inspect' && $method === 'POST'`  
  → **handle_inspect()** 호출 (api/handlers/inspect.php)

---

## 4. PHP 핸들러 (api/handlers/inspect.php)

1. **입력 읽기**
   - `read_json_body()`: `php://input`에서 JSON 읽어 `text`, `user_id`, `project`, `title` 등 추출
   - `text` 없으면 400 + `{ "error": "text 필드가 필요합니다." }`

2. **검수 실행**
   - `adsafe_inspect_run($rawText)` 호출 (api/engine/inspection_engine.php)
   - 소요 시간 측정 후 `$result['processingMs']` 설정

3. **DB 저장 (기본: save≠0 일 때)**
   - `get_pdo()`로 MySQL 연결 (api/lib/bootstrap.php, .env 기반)
   - **inspection_runs** 1건 INSERT  
     (workspace_id=1, ad_type, ad_title, risk_summary_level, total_findings, normalized_text, processing_ms, created_by 등)
   - `lastInsertId()` → `runId`를 응답에 포함
   - **inspection_findings**를 루프로 INSERT  
     (run_id, risk_code, risk_level, matched_text, explanation_body, suggestion 등)

4. **응답**
   - `json_response($result)` → 위 2.3 형식의 JSON으로 응답

---

## 5. 검수 엔진 (api/engine/inspection_engine.php)

### 5.1 의존 파일

- `normalize.php` → `adsafe_normalize($rawText)`
- `rules_data.php` → `adsafe_rules()`

### 5.2 처리 순서

1. **전처리**
   - `adsafe_normalize($rawText)`: 공백·줄바꿈 정리, 특수문자·구두점 처리, 소문자화 등

2. **룰 로딩**
   - `adsafe_rules()` (rules_data.php):
     - **우선**: DB에서 `rule_set_versions.status='active'`인 룰셋의 `rules` + `risk_taxonomy` 조인하여 키워드/정규식/설명 등 로드
     - **실패 시**: `api/engine/rules_data.json` 파일을 읽어 사용 (정적 fallback)

3. **매칭**
   - 각 룰의 `keywords`로 문자열 검색, `regex`로 정규식 검색
   - 원문에 실제로 존재하는지 검사 후 `findings`에 추가 (riskCode, riskLevel, matchedText, explanation, suggestion, level1~3)

4. **이벤트/할인 규칙**
   - 50% 이상 할인, 할인율 미기재, 이벤트 기간 미표기 등 추가 규칙 적용

5. **요약**
   - findings 개수와 high/medium/low 유무로 `summary.level`, `summary.totalFindings`, `summary.message` 결정

6. **반환**
   - `summary`, `findings`, `rawText`, `normalizedText` 배열 반환 → 핸들러에서 `processingMs`, `runId`, `saveError` 추가 후 JSON 응답

---

## 6. DB 및 ERD

### 6.1 검수하기와 직접 연결된 테이블 (ERD 요약)

| 테이블 | 역할 |
|--------|------|
| **inspection_runs** | 검수 실행 1건 (실행일시, 요약 위험도, normalized_text, processing_ms, created_by 등) |
| **inspection_findings** | 적발 항목 1건씩 (run_id, risk_code, risk_level, matched_text, explanation, suggestion) |

- `inspection_runs` → `workspaces`, `users`(created_by) 참조
- `inspection_findings` → `inspection_runs`(run_id), `risk_taxonomy`(risk_code) 참조

### 6.2 룰/택소노미 (검수 시 사용)

- **rule_set_versions**: 룰셋 버전 (status='active'인 것 사용)
- **rules**: 룰 (rule_set_version_id, risk_code, pattern, rule_type 등)
- **risk_taxonomy**: risk_code별 level_1~3, default_risk_level, description

검수 시 `adsafe_rules()`가 위 테이블에서 활성 룰을 읽고, 실패 시 **rules_data.json**을 사용합니다.

### 6.3 ERD 다이어그램 위치

- **docs/sql/ERD_adsafe.md**  
  - 전체 ERD (Mermaid)  
  - "검수하기 버튼과 연결된 테이블" 요약 표

---

## 7. JSON이 쓰이는 곳

| 구분 | 파일/위치 | 역할 |
|------|-----------|------|
| **요청** | 브라우저 → API | body: `{ "text", "project", "title", "user_id" }` |
| **응답** | API → 브라우저 | `summary`, `findings`, `rawText`, `normalizedText`, `runId`, `saveError` 등 |
| **룰 fallback** | api/engine/rules_data.json | DB 룰 로드 실패 시 검수 엔진이 사용하는 정적 룰 데이터 |

---

## 8. 파일별 역할 정리

| 단계 | 파일 | 역할 |
|------|------|------|
| 화면 | adsafe.html | 검수하기 버튼, 입력란, 결과 영역 |
| 클라이언트 | main.js | 검수하기 클릭 → POST /api/inspect → 결과 렌더링 |
| 진입 | api/.htaccess | /api/* → index.php |
| 진입 | api/index.php | bootstrap + routes 로드 |
| 공통 | api/lib/bootstrap.php | CORS, json_response, read_json_body, get_pdo |
| 라우팅 | api/routes.php | POST /inspect → handle_inspect() |
| 핸들러 | api/handlers/inspect.php | JSON 파싱, 검수 호출, DB 저장, JSON 응답 |
| 엔진 | api/engine/inspection_engine.php | 전처리 + 룰 매칭 + 요약 |
| 전처리 | api/engine/normalize.php | adsafe_normalize() |
| 룰 | api/engine/rules_data.php | DB 룰 조회 → 실패 시 rules_data.json |
| 룰 데이터 | api/engine/rules_data.json | 정적 룰 fallback |
| ERD/구조 | docs/sql/ERD_adsafe.md | inspection_runs, inspection_findings 등 테이블 관계 |

---

이 문서는 검수하기 버튼 한 번의 동작이 **브라우저 → API → PHP → DB/JSON**을 어떻게 타고 흐르는지 설명합니다.  
실제 요청/응답을 보려면 브라우저 개발자 도구(F12) → Network 탭에서 `inspect` 요청을 확인하면 됩니다.
